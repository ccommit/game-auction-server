<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ccommit.gameauctionserver.mapper.BidMapper">

    <select id="isExistItemId" resultType="java.lang.Integer">
        SELECT  id
        FROM    bid
        WHERE   item_id = #{itemId}
    </select>

    <insert id="registrationItem" parameterType="com.ccommit.gameauctionserver.dto.User">
        <selectKey keyProperty="id" order="AFTER" resultType="int">
                            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO bid (   create_time,
                            limit_time,
                            price,
                            start_price,
                            present_price,
                            seller_id,
                            issold,
                            item_id)

        VALUES (            NOW(),
                            DATE_ADD(NOW(), INTERVAL 1 DAY),
                            #{price},
                            #{startPrice},
                            #{startPrice},
                            #{sellerId},
                            #{isSold},
                            #{itemId});
    </insert>

    <select id="readLastItemToBid" resultType="com.ccommit.gameauctionserver.dto.Bid">
        SELECT   *
        FROM     bid
        WHERE    id = LAST_INSERT_ID()
    </select>

    <select id="searchBidToItem" resultType="com.ccommit.gameauctionserver.dto.bid.ResponseItemToBid">
        SELECT   b.id               AS id,
                 i.name             AS name,
                 i.equipment_level  AS equipmentLevel,
                 i.first_property   AS firstProperty,
                 i.second_property  AS secondProperty,
                 i.item_image_url   AS itemImageURL,
                 b.price            AS price,
                 b.present_price    AS presentPrice
        FROM     bid b
        JOIN     item i             ON b.item_id = i.id
        WHERE    1 = 1
        <if test="minLevel != null">
                 AND #{minLevel} &lt; i.equipment_level
        </if>
        <if test="maxLevel != null">
                 AND #{maxLevel} &gt; i.equipment_level
        </if>
        <if test="maxPrice != null">
                 AND #{maxPrice} &gt; b.price
        </if>
        <if test="minFirstProperty != null">
                 AND #{minFirstProperty} &lt; i.first_property
        </if>
        <if test="minSecondProperty != null">
                 AND #{minSecondProperty} &lt; i.second_property
        </if>
        <if test="itemRating != null">
                 AND #{itemRating} = i.rating
        </if>
        <if test="mainCategory != null">
                 AND #{mainCategory} = i.main_type
        </if>
        <if test="subCategory != null">
                 AND #{subCategory} = 1.sub_type
        </if>

        <if test ="bidSortingType != null">
            <if test="bidSortingType == 'NAME'">
                 ORDER BY i.name
            </if>
            <if test="bidSortingType.toString() == 'LIMIT_TIME'">
                 ORDER BY b.limit_time
            </if>
            <if test="bidSortingType.toString() == 'PRESENT_PRICE'">
                 ORDER BY b.present_price
            </if>
            <if test="bidSortingType.toString() == 'PRICE'">
                 ORDER BY b.price
            </if>

            <if test ="desc">
                 DESC
            </if>
            <if test ="!desc">
                 ASC
            </if>
        </if>

        LIMIT #{limitPage} OFFSET #{offset}
    </select>

</mapper>