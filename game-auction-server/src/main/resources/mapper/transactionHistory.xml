<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ccommit.gameauctionserver.mapper.TransactionHistoryMapper">

    <insert id="insertTransactionHistory">
        <selectKey keyProperty="id" order="AFTER" resultType="int">
            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO transactionhistory (    seller_id,
                                            buyer_id,
                                            sale_time,
                                            item_id,
                                            trade_price)
        VALUES
        <foreach collection="transactionHistoryList" item="transactionHistory" separator=",">
            (
            #{transactionHistory.sellerId},
            #{transactionHistory.highestBidderId},
            NOW(),
            #{transactionHistory.itemId},
            <choose>
                <when test ="transactionHistory.price == transactionHistory.presentPrice">
                    #{transactionHistory.price}
                </when>
                <otherwise>
                    #{transactionHistory.presentPrice}
                </otherwise>
            </choose>
            )
        </foreach>
    </insert>

    <select id="readTransactionHistoryByUserId" resultType="com.ccommit.gameauctionserver.dto.TransactionHistoryDTO">
        SELECT      id,
                    seller_id   AS sellerId,
                    buyer_id    AS buyerId,
                    sale_time   AS saleTime,
                    trade_price AS tradePrice,
                    item_id     AS itemId
        FROM        transactionhistory
        WHERE       seller_id = #{userId}
        OR          buyer_id  = #{userId}
    </select>

    <select id="readTransactionHistoryData" resultType="com.ccommit.gameauctionserver.dto.TransactionHistoryDTO">
        SELECT  history.id,
                history.seller_id   AS sellerId,
                history.buyer_id    AS buyerId,
                history.sale_time   AS saleTime,
                history.trade_price AS tradePrice,
                history.item_id     AS itemId
        FROM    transactionhistory history
        <choose>
            <when test="itemName != null">
                JOIN    item i ON history.item_id = i.id
                WHERE   i.name = #{itemName}
            </when>
            <otherwise>
                WHERE   history.seller_id = #{userId}
                OR      history.buyer_id  = #{userId}
            </otherwise>
        </choose>
    </select>

    <select id="readTransactionHistoryByItemName" resultType="com.ccommit.gameauctionserver.dto.TransactionHistoryDTO">
        SELECT      history.id,
                    history.seller_id   AS sellerId,
                    history.buyer_id    AS buyerId,
                    history.sale_time   AS saleTime,
                    history.trade_price AS tradePrice,
                    history.item_id     AS itemId
        FROM        transactionhistory history
        JOIN        item i ON history.item_id = i.id
        WHERE       i.name = #{itemName}
    </select>

</mapper>